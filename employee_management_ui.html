<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 0;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 30px 20px;
            border-right: 1px solid #e0e0e0;
        }

        .menu-btn {
            width: 100%;
            padding: 15px 20px;
            margin-bottom: 10px;
            border: none;
            background: white;
            color: #333;
            font-size: 1em;
            font-weight: 500;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-btn:hover {
            background: #667eea;
            color: white;
            transform: translateX(5px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .menu-btn.active {
            background: #667eea;
            color: white;
        }

        .content-area {
            padding: 30px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .employee-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .employee-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .employee-table th, .employee-table td {
            padding: 15px;
            text-align: left;
        }

        .employee-table tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: background 0.2s;
        }

        .employee-table tbody tr:hover {
            background: #f8f9fa;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .action-btn-view {
            background: #17a2b8;
            color: white;
        }

        .action-btn-edit {
            background: #ffc107;
            color: #333;
        }

        .action-btn-delete {
            background: #dc3545;
            color: white;
        }

        .action-btn:hover {
            transform: scale(1.05);
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .employee-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .employee-card h3 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .employee-detail {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .employee-detail strong {
            color: #666;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .icon {
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üë• Employee Management System</h1>
            <p>Complete CRUD Operations - Create, Read, Update, Delete</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <button class="menu-btn active" onclick="showSection('dashboard')">
                    <span class="icon">üìä</span> Dashboard
                </button>
                <button id="menu-add" class="menu-btn" onclick="showSection('create')">
                    <span class="icon">‚ûï</span> Add Employee
                </button>
                        <button id="menu-users" class="menu-btn" onclick="showSection('users')">
                            <span class="icon">üë•</span> Manage Users
                        </button>
                <button class="menu-btn" onclick="showSection('view')">
                    <span class="icon">üëÅÔ∏è</span> View All
                </button>
                <button class="menu-btn" onclick="showSection('search')">
                    <span class="icon">üîç</span> Search
                </button>
            </div>

            <div class="content-area">
                <div style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:12px;">
                    <div id="user-info" style="color:#fff; align-self:flex-start; margin-top:-6px;"></div>
                    <button id="logoutBtn" class="btn btn-secondary" style="align-self:flex-start;">Logout</button>
                </div>
                <div id="alert-container"></div>

                <!-- Dashboard Section -->
                <div id="dashboard" class="section active">
                    <h2>üìä Dashboard</h2>
                    <div class="stats" style="margin-top: 20px;">
                        <div class="stat-card">
                            <h3 id="total-employees">0</h3>
                            <p>Total Employees</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="total-departments">0</h3>
                            <p>Departments</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="avg-salary">$0</h3>
                            <p>Average Salary</p>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px; margin-bottom: 15px;">Recent Employees</h3>
                    <table class="employee-table" id="dashboard-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Position</th>
                                <th>Department</th>
                                <th>Salary</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <!-- Create Section -->
                <div id="create" class="section">
                    <h2>‚ûï Add New Employee</h2>
                    <form id="create-form" style="margin-top: 20px;">
                        <div class="form-group">
                            <label for="emp-id">Employee ID *</label>
                            <input type="text" id="emp-id" required placeholder="e.g., E001">
                        </div>
                        <div class="form-group">
                            <label for="emp-name">Full Name *</label>
                            <input type="text" id="emp-name" required placeholder="e.g., John Smith">
                        </div>
                        <div class="form-group">
                            <label for="emp-position">Position *</label>
                            <input type="text" id="emp-position" required placeholder="e.g., Software Engineer">
                        </div>
                        <div class="form-group">
                            <label for="emp-department">Department *</label>
                            <input type="text" id="emp-department" required placeholder="e.g., IT">
                        </div>
                        <div class="form-group">
                            <label for="emp-salary">Salary *</label>
                            <input type="number" id="emp-salary" required placeholder="e.g., 75000" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="emp-email">Email *</label>
                            <input type="email" id="emp-email" required placeholder="e.g., john.smith@company.com">
                        </div>
                        <div class="form-group">
                            <label for="emp-phone">Phone *</label>
                            <input type="tel" id="emp-phone" required placeholder="e.g., 555-1234">
                        </div>
                        <button type="submit" class="btn btn-primary">Create Employee</button>
                        <button type="reset" class="btn btn-secondary">Clear Form</button>
                    </form>
                </div>

                <!-- View All Section -->
                <div id="view" class="section">
                    <h2>üëÅÔ∏è All Employees</h2>
                    <div id="view-all-content"></div>
                </div>

                <!-- Users Management (Admin) -->
                <div id="users" class="section">
                    <h2>üë• Manage Users</h2>
                    <div id="users-alert" style="margin-top:12px;"></div>

                    <div style="display:flex; gap:20px; margin-top:20px; flex-wrap:wrap;">
                        <div style="flex:1; min-width:320px;">
                            <h3>Create New User</h3>
                            <form id="create-user-form" style="margin-top:12px;">
                                <div class="form-group">
                                    <label for="user-email">Email *</label>
                                    <input type="email" id="user-email" required placeholder="user@example.com">
                                </div>
                                <div class="form-group">
                                    <label for="user-name">Name</label>
                                    <input type="text" id="user-name" placeholder="Display name">
                                </div>
                                <div class="form-group">
                                    <label for="user-password">Password *</label>
                                    <input type="password" id="user-password" required placeholder="at least 3 chars">
                                </div>
                                <div class="form-group">
                                    <label for="user-role">Role</label>
                                    <select id="user-role">
                                        <option value="user">User</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Create User</button>
                                <button type="reset" class="btn btn-secondary">Clear</button>
                            </form>
                        </div>

                        <div style="flex:2; min-width:320px;">
                            <h3>Existing Users</h3>
                            <div id="users-list" style="margin-top:12px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Search Section -->
                <div id="search" class="section">
                    <h2>üîç Search Employees</h2>
                    <div class="search-box" style="margin-top: 20px;">
                        <input type="text" id="search-input" placeholder="Search by name, position, or department...">
                    </div>
                    <div id="search-results"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="ui/app.js"></script>
    <script>
                // Ensure user is authenticated and expose session
                const _session = window.app && window.app.requireAuth ? window.app.requireAuth('ui/login.html') : null;
                if (!_session) {
                    // requireAuth will redirect; stop further execution
                }

                // Employee data storage (simulating database)
                let employees = {};

        // Load data from localStorage
        function loadData() {
            const saved = localStorage.getItem('employeeData');
            if (saved) {
                employees = JSON.parse(saved);
            } else {
                // Add sample data
                employees = {
                    'E001': {
                        name: 'John Smith',
                        position: 'Software Engineer',
                        department: 'IT',
                        salary: 75000,
                        email: 'john.smith@company.com',
                        phone: '555-0101',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    },
                    'E002': {
                        name: 'Sarah Johnson',
                        position: 'Marketing Manager',
                        department: 'Marketing',
                        salary: 68000,
                        email: 'sarah.j@company.com',
                        phone: '555-0102',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    },
                    'E003': {
                        name: 'Michael Brown',
                        position: 'Data Analyst',
                        department: 'IT',
                        salary: 65000,
                        email: 'michael.b@company.com',
                        phone: '555-0103',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }
                };
                saveData();
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('employeeData', JSON.stringify(employees));
        }

        // Show alert message
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Show section
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.menu-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            event.target.closest('.menu-btn').classList.add('active');
            
            if (sectionId === 'dashboard') {
                updateDashboard();
            } else if (sectionId === 'users') {
                displayUsers();
            } else if (sectionId === 'view') {
                displayAllEmployees();
            }
        }

        // Update dashboard
        function updateDashboard() {
            const totalEmployees = Object.keys(employees).length;
            const departments = new Set(Object.values(employees).map(e => e.department));
            const avgSalary = totalEmployees > 0 
                ? Object.values(employees).reduce((sum, e) => sum + e.salary, 0) / totalEmployees 
                : 0;

            document.getElementById('total-employees').textContent = totalEmployees;
            document.getElementById('total-departments').textContent = departments.size;
            document.getElementById('avg-salary').textContent = '$' + avgSalary.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");

            const tbody = document.querySelector('#dashboard-table tbody');
            tbody.innerHTML = '';
            
            const recentEmployees = Object.entries(employees).slice(-5);
            recentEmployees.forEach(([id, emp]) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${id}</td>
                    <td>${emp.name}</td>
                    <td>${emp.position}</td>
                    <td>${emp.department}</td>
                    <td>$${emp.salary.toLocaleString()}</td>
                `;
            });

            if (totalEmployees === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">No employees yet. Add your first employee!</td></tr>';
            }
        }

        // Create employee
        document.getElementById('create-form').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!window.app.isAdmin()) {
                showAlert('Only admin can create employees.', 'error');
                return;
            }
            
            const empId = document.getElementById('emp-id').value.trim();
            const name = document.getElementById('emp-name').value.trim();
            const position = document.getElementById('emp-position').value.trim();
            const department = document.getElementById('emp-department').value.trim();
            const salary = parseFloat(document.getElementById('emp-salary').value);
            const email = document.getElementById('emp-email').value.trim();
            const phone = document.getElementById('emp-phone').value.trim();

            if (employees[empId]) {
                showAlert(`Error: Employee with ID ${empId} already exists!`, 'error');
                return;
            }

            employees[empId] = {
                name, position, department, salary, email, phone,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };

            saveData();
            showAlert(`‚úÖ Employee ${name} (ID: ${empId}) created successfully!`, 'success');
            this.reset();
            updateDashboard();
        });

        // Display all employees
        function displayAllEmployees() {
            const container = document.getElementById('view-all-content');
            
            if (Object.keys(employees).length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No employees in the system.</p></div>';
                return;
            }

            let html = '<table class="employee-table"><thead><tr>' +
                '<th>ID</th><th>Name</th><th>Position</th><th>Department</th><th>Salary</th><th>Actions</th>' +
                '</tr></thead><tbody>';

            for (const [id, emp] of Object.entries(employees)) {
                const actions = `<button class="action-btn action-btn-view" onclick="viewEmployee('${id}')">View</button>` +
                    (window.app.isAdmin() ? ` <button class="action-btn action-btn-edit" onclick="editEmployee('${id}')">Edit</button> <button class="action-btn action-btn-delete" onclick="deleteEmployee('${id}')">Delete</button>` : '');

                html += `<tr>
                    <td>${id}</td>
                    <td>${emp.name}</td>
                    <td>${emp.position}</td>
                    <td>${emp.department}</td>
                    <td>$${emp.salary.toLocaleString()}</td>
                    <td>${actions}</td>
                </tr>`;
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // View employee details
        function viewEmployee(empId) {
            const emp = employees[empId];
            if (!emp) {
                showAlert('Employee not found!', 'error');
                return;
            }

            const modal = `
                <div class="employee-card">
                    <h3>Employee Details: ${empId}</h3>
                    <div class="employee-detail"><strong>Name:</strong> <span>${emp.name}</span></div>
                    <div class="employee-detail"><strong>Position:</strong> <span>${emp.position}</span></div>
                    <div class="employee-detail"><strong>Department:</strong> <span>${emp.department}</span></div>
                    <div class="employee-detail"><strong>Salary:</strong> <span>$${emp.salary.toLocaleString()}</span></div>
                    <div class="employee-detail"><strong>Email:</strong> <span>${emp.email}</span></div>
                    <div class="employee-detail"><strong>Phone:</strong> <span>${emp.phone}</span></div>
                    <div class="employee-detail"><strong>Created:</strong> <span>${new Date(emp.created_at).toLocaleString()}</span></div>
                    <div class="employee-detail"><strong>Updated:</strong> <span>${new Date(emp.updated_at).toLocaleString()}</span></div>
                </div>
            `;

            showAlert(modal, 'info');
        }

        // Edit employee
        function editEmployee(empId) {
            if (!window.app.isAdmin()) {
                showAlert('Only admin can edit employees.', 'error');
                return;
            }
            const emp = employees[empId];
            if (!emp) {
                showAlert('Employee not found!', 'error');
                return;
            }

            const newName = prompt('Enter new name:', emp.name);
            if (newName && newName.trim()) emp.name = newName.trim();

            const newPosition = prompt('Enter new position:', emp.position);
            if (newPosition && newPosition.trim()) emp.position = newPosition.trim();

            const newDepartment = prompt('Enter new department:', emp.department);
            if (newDepartment && newDepartment.trim()) emp.department = newDepartment.trim();

            const newSalary = prompt('Enter new salary:', emp.salary);
            if (newSalary && !isNaN(newSalary)) emp.salary = parseFloat(newSalary);

            const newEmail = prompt('Enter new email:', emp.email);
            if (newEmail && newEmail.trim()) emp.email = newEmail.trim();

            const newPhone = prompt('Enter new phone:', emp.phone);
            if (newPhone && newPhone.trim()) emp.phone = newPhone.trim();

            emp.updated_at = new Date().toISOString();
            saveData();
            showAlert(`‚úÖ Employee ${empId} updated successfully!`, 'success');
            displayAllEmployees();
            updateDashboard();
        }

        // Delete employee
        function deleteEmployee(empId) {
            if (!window.app.isAdmin()) {
                showAlert('Only admin can delete employees.', 'error');
                return;
            }
            if (!employees[empId]) {
                showAlert('Employee not found!', 'error');
                return;
            }

            if (confirm(`Are you sure you want to delete employee ${empId} (${employees[empId].name})?`)) {
                const empName = employees[empId].name;
                delete employees[empId];
                saveData();
                showAlert(`‚úÖ Employee ${empName} (ID: ${empId}) deleted successfully!`, 'success');
                displayAllEmployees();
                updateDashboard();
            }
        }

        // Search employees
        document.getElementById('search-input').addEventListener('input', function(e) {
            const keyword = e.target.value.toLowerCase();
            const container = document.getElementById('search-results');

            if (keyword.length === 0) {
                container.innerHTML = '';
                return;
            }

            const results = Object.entries(employees).filter(([id, emp]) => {
                return emp.name.toLowerCase().includes(keyword) ||
                       emp.position.toLowerCase().includes(keyword) ||
                       emp.department.toLowerCase().includes(keyword);
            });

            if (results.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No employees found matching your search.</p></div>';
                return;
            }

            let html = '<table class="employee-table"><thead><tr>' +
                '<th>ID</th><th>Name</th><th>Position</th><th>Department</th><th>Salary</th><th>Actions</th>' +
                '</tr></thead><tbody>';

            results.forEach(([id, emp]) => {
                const actions = `<button class="action-btn action-btn-view" onclick="viewEmployee('${id}')">View</button>` +
                    (window.app.isAdmin() ? ` <button class="action-btn action-btn-edit" onclick="editEmployee('${id}')">Edit</button> <button class="action-btn action-btn-delete" onclick="deleteEmployee('${id}')">Delete</button>` : '');

                html += `<tr>
                    <td>${id}</td>
                    <td>${emp.name}</td>
                    <td>${emp.position}</td>
                    <td>${emp.department}</td>
                    <td>$${emp.salary.toLocaleString()}</td>
                    <td>${actions}</td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        });

        // Initialize
        // --- User management functions (Admin) ---
        function showUsersAlert(message, type = 'success') {
            const el = document.getElementById('users-alert');
            el.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => { el.innerHTML = ''; }, 5000);
        }

        function displayUsers() {
            const container = document.getElementById('users-list');
            if (!window.app.isAdmin()) {
                container.innerHTML = '<div class="empty-state">Only administrators can manage users.</div>';
                return;
            }

            const users = window.app.getUsers();
            const rows = Object.entries(users).map(([email, u]) => {
                return `<tr>
                    <td>${email}</td>
                    <td>${u.name || ''}</td>
                    <td>${u.role}</td>
                    <td style="white-space:nowrap;">` +
                    `<button class="action-btn action-btn-edit" onclick="editUserAccount('${email}')">Edit</button>` +
                    ` <button class="action-btn action-btn-delete" onclick="deleteUserAccount('${email}')">Delete</button>` +
                    `</td>
                </tr>`;
            }).join('');

            const html = `<table class="employee-table"><thead><tr><th>Email</th><th>Name</th><th>Role</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`;
            container.innerHTML = html;
        }

        document.getElementById('create-user-form').addEventListener('submit', function(e){
            e.preventDefault();
            if (!window.app.isAdmin()) {
                showUsersAlert('Only admin can create users.', 'error');
                return;
            }

            const email = document.getElementById('user-email').value.trim().toLowerCase();
            const name = document.getElementById('user-name').value.trim();
            const password = document.getElementById('user-password').value;
            const role = document.getElementById('user-role').value;

            const res = window.app.addUser(email, password, role, name);
            if (!res.ok) {
                showUsersAlert(res.message || 'Failed to create user', 'error');
                return;
            }
            showUsersAlert('‚úÖ User created successfully', 'success');
            this.reset();
            displayUsers();
        });

        window.editUserAccount = function(email) {
            if (!window.app.isAdmin()) { showUsersAlert('Only admin can edit users.', 'error'); return; }
            const users = window.app.getUsers();
            const u = users[email];
            if (!u) { showUsersAlert('User not found', 'error'); return; }

            const newName = prompt('Display name:', u.name || '');
            const newRole = prompt('Role (admin/user):', u.role);
            const changePass = confirm('Change password for user?');
            let newPass = null;
            if (changePass) newPass = prompt('Enter new password (min 3 chars):');

            const changes = {};
            if (typeof newName === 'string') changes.name = newName;
            if (newRole) changes.role = newRole;
            if (newPass) changes.password = newPass;

            const res = window.app.updateUser(email, changes);
            if (!res.ok) { showUsersAlert(res.message || 'Failed to update user', 'error'); return; }
            showUsersAlert('‚úÖ User updated', 'success');
            displayUsers();
        };

        window.deleteUserAccount = function(email){
            if (!window.app.isAdmin()) { showUsersAlert('Only admin can delete users.', 'error'); return; }
            if (!confirm('Delete user ' + email + '?')) return;
            const res = window.app.deleteUser(email);
            if (!res.ok) { showUsersAlert(res.message || 'Failed to delete user', 'error'); return; }
            showUsersAlert('‚úÖ User deleted', 'success');
            displayUsers();
        };

        loadData();
        updateDashboard();
        // Show/hide admin features
        try {
            const session = window.app.getSession();
            const userInfo = document.getElementById('user-info');
            if (userInfo && session) {
                userInfo.textContent = `${session.name} (${session.role})`;
            }

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(){
                    window.app.logout();
                    window.location.href = 'ui/login.html';
                });
            }

            // Hide create menu for non-admins
            if (!window.app.isAdmin()) {
                const menuAdd = document.getElementById('menu-add');
                if (menuAdd) menuAdd.style.display = 'none';
                const menuUsers = document.getElementById('menu-users');
                if (menuUsers) menuUsers.style.display = 'none';
            }
        } catch (err) {
            // ignore
        }
    </script>
</body>
</html>
